# Fix Database Issue - Migration Problem

## Problem Identified

The Plaid integration migration adds `is_connected` columns to `assets` and `liabilities` tables as `NOT NULL` without a default value. This causes the migration to **fail on existing data** because existing rows don't have a value for `is_connected`.

## What Happened

1. Migration tried to add `is_connected BOOLEAN NOT NULL` to existing tables
2. Existing rows couldn't get a value, causing migration to fail
3. Database might be in a partially migrated state
4. This breaks API queries that expect the column to exist

## Fix Applied

### 1. Fixed Migration File
Updated `backend/alembic/versions/20251229_0517_8cc070c9fc07_add_plaid_integration_connected_.py`:
- Added `server_default='false'` to `is_connected` columns
- This ensures existing rows get `false` as default value

### 2. Database Fix Scripts

**If migration already ran and failed**, run these SQL commands:

```sql
-- Fix assets table
ALTER TABLE assets 
  ALTER COLUMN is_connected SET DEFAULT false;

UPDATE assets 
  SET is_connected = false 
  WHERE is_connected IS NULL;

-- Fix liabilities table
ALTER TABLE liabilities 
  ALTER COLUMN is_connected SET DEFAULT false;

UPDATE liabilities 
  SET is_connected = false 
  WHERE is_connected IS NULL;
```

Or use the provided script: `backend/fix_migration_defaults.sql`

## How to Fix on Railway

### Option 1: Run the Fix SQL Script

1. Go to Railway dashboard â†’ Your backend service
2. Open the PostgreSQL database (or Supabase)
3. Run the SQL from `backend/fix_migration_defaults.sql`

### Option 2: Re-run Migration (if it failed)

If the migration partially applied:

1. Check current state:
   ```sql
   -- Check if columns exist
   SELECT column_name 
   FROM information_schema.columns 
   WHERE table_name = 'assets' 
     AND column_name = 'is_connected';
   ```

2. If columns don't exist, the migration didn't run. You can:
   - Run the fixed migration manually
   - Or let Railway run it on next deploy

3. If columns exist but have NULL values:
   ```sql
   -- Set defaults and update NULLs
   ALTER TABLE assets ALTER COLUMN is_connected SET DEFAULT false;
   UPDATE assets SET is_connected = false WHERE is_connected IS NULL;
   
   ALTER TABLE liabilities ALTER COLUMN is_connected SET DEFAULT false;
   UPDATE liabilities SET is_connected = false WHERE is_connected IS NULL;
   ```

### Option 3: Check Database Schema

Run `backend/check_database_schema.sql` to diagnose the current state.

## Verification

After fixing, verify the schema:

```sql
-- Should show is_connected with default false
SELECT column_name, data_type, is_nullable, column_default
FROM information_schema.columns 
WHERE table_name = 'assets' 
  AND column_name = 'is_connected';

-- Should return 0 (no NULL values)
SELECT COUNT(*) 
FROM assets 
WHERE is_connected IS NULL;
```

## Next Steps

1. **Fix the database** using one of the options above
2. **Redeploy backend** - the fixed migration will be used for new deployments
3. **Test the API** - assets and liabilities should load correctly now

## Why This Happened

The migration was auto-generated by Alembic, and it didn't include default values for the new `NOT NULL` columns. This is a common issue when adding required columns to existing tables with data.

## Prevention

For future migrations:
- Always add `server_default` for `NOT NULL` columns on existing tables
- Or make columns nullable first, update data, then make them NOT NULL
- Test migrations on a copy of production data first

